"use strict";var gmail=function(){var i;function g(e){return e?e.textContent:null}return i={getUnreadEmails:function(e){return new Promise(function(u,d){var h=new XMLHttpRequest;h.onreadystatechange=function(){var e,i;if(4==h.readyState)if(h.responseXML){var t=h.responseXML,n=g(t.querySelector("title"));if(n)try{n=/(\w+)@(\w+\.\w+)/.exec(n)[0]}catch(e){}for(var a=parseInt(g(t.querySelector("fullcount")),10),r=t.querySelectorAll("entry"),o=[],l=-1,s=0,c=r.length;s<c;s++){var m=r[s],m={id:g(m.querySelector("id")),title:g(m.querySelector("title")),summary:g(m.querySelector("summary")),link:(e=m.querySelector("link"),i="href",e?e.getAttribute(i):null),authorEmail:g(m.querySelector("author email")),authorName:g(m.querySelector("author name")),issued:g(m.querySelector("issued"))};m.issued&&(m.issued=new Date(m.issued).valueOf(),l=Math.max(l,m.issued)),o.push(m)}u({account:n,lastIssuedTime:l,count:a,emails:o})}else d()},h.onerror=d,h.open("GET","https://mail.google.com/mail/feed/atom?zx="+encodeURIComponent(e),!0),h.send(null)})}},{check:function(){var s,c,m;return Promise.resolve(new Promise(function(e){chrome.storage.local.get("infinity-gmail",e)}).then(function(e){return{model:e["infinity-gmail"]||{account:null,lastIssuedTime:-1,instanceId:"gmc"+parseInt(Date.now()*Math.random(),10),emails:[]}}})).then(function(e){return s=e,i.getUnreadEmails(s.model.instanceId)}).then(function(e){var i,t=s.model.account,n=s.model.lastIssuedTime,a=e.emails;if(c=[],t===e.account)for(var r=0,o=a.length;r<o;r++){var l=a[r];l.issued>n&&c.push(l)}return m=e.count,s.model.account=e.account,s.model.lastIssuedTime=Math.max(n,e.lastIssuedTime),s.model.emails=a,i=s,new Promise(function(e){chrome.storage.local.set({"infinity-gmail":i.model},e)})}).then(function(){return{newEmails:c,unreadEmailCount:m}})},reset:function(){chrome.storage.local.remove("infinity-gmail")}}}(),bgGmail={delayTime:1,init:function(){var i=this;i.check(),chrome.alarms.onAlarm.addListener(function(e){"gmailCheck"==e.name&&i.check()}),infinity.onMessage("settingChange",function(e){"isOpentGmailNotication"!=e.type&&"isShowGmailNum"!=e.type||((e=infinity.get("infinity-settings")).isOpentGmailNotication||e.isShowGmailNum)&&i.check()})},check:function(){var n=this,a=void 0;chrome.alarms.clear("gmailCheck"),(a=infinity.get("infinity-settings")).isOpentGmailNotication||a.isShowGmailNum?gmail.check().then(function(e){var i=a.gmailUnreadNum;e.unreadEmailCount>i&&infinity.sendMessage("updateGmailUnreadNum"),infinity.setting("gmailUnreadNum",e.unreadEmailCount),a=infinity.get("infinity-settings");var t,e=e.newEmails;a.isOpentGmailNotication&&(t=void 0,e.map(function(e,i){t={type:"basic",contextMessage:e.authorName+"("+e.authorEmail+")",title:e.title,message:e.summary,iconUrl:"/icon/gmail.png",isClickable:!0},a.isOpentGmailRingNotication&&n.ring(),chrome.notifications.create(e.link,t,function(){})}),chrome.alarms.create("gmailCheck",{delayInMinutes:n.delayTime}))}).catch(function(e){chrome.alarms.create("gmailCheck",{delayInMinutes:n.delayTime})}):chrome.alarms.clear("gmailCheck")},ring:function(){var e=new Audio("/background/res/ring.mp3");e.play(),e.remove()}};